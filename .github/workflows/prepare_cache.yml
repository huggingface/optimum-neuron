name: Optimum neuron / Prepare dependecies cache

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]


concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  do-the-job:
    name: Setup Inf2 Neuronx system cache
    runs-on:
      group: aws-inf2-8xlarge
    env:
      APT_CACHE_DIR: /mnt/hf_cache/apt-${{ github.sha }}
    steps:
      - name: Download Neuronx system packages
        shell: bash
        run: |
          sudo mkdir -p ${APT_CACHE_DIR}
          sudo chmod 777 ${APT_CACHE_DIR}
          . /etc/os-release
          sudo tee /etc/apt/sources.list.d/neuron.list > /dev/null <<EOF
          deb https://apt.repos.neuron.amazonaws.com ${VERSION_CODENAME} main
          EOF
          wget -qO - https://apt.repos.neuron.amazonaws.com/GPG-PUB-KEY-AMAZON-AWS-NEURON.PUB | sudo apt-key add -
          sudo apt-get update
          sudo apt-get install -y --download-only \
            -o Dir::Cache::archives="$APT_CACHE_DIR" \
            aws-neuronx-tools=2.26.14.0 aws-neuronx-runtime-lib=2.28.23.0-dd5879008 aws-neuronx-collectives=2.28.27.0-bc30ece58
          echo "➡️ Neuronx system dependencies downloaded to ${APT_CACHE_DIR}"
          ls ${APT_CACHE_DIR}/*.deb
